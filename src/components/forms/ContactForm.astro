---
/**
 * ContactForm - Konzultáció kérés form
 * Based on astro-forms skill
 *
 * Features:
 * - Zod validation
 * - Honeypot spam protection
 * - Time-check (minimum 3s to fill)
 * - Cloudflare Turnstile CAPTCHA
 * - GDPR consent with timestamp
 * - UTM parameter tracking
 * - i18n support
 */
import { CATEGORIES } from '@/lib/constants';
import { getTurnstileSiteKey } from '@/lib/forms/turnstile';
import { t, getLocaleFromUrl, type Locale } from '@/i18n/ui';

interface Props {
  /** Pre-selected product category */
  product?: string;
  /** Source URL for tracking */
  sourceUrl?: string;
  /** Show compact version */
  compact?: boolean;
  /** Custom class */
  class?: string;
}

const {
  product = '',
  sourceUrl = Astro.url.href,
  compact = false,
  class: className = '',
} = Astro.props;

const locale = getLocaleFromUrl(Astro.url) as Locale;
const turnstileSiteKey = getTurnstileSiteKey();

// Localized privacy policy link
const privacyLink = locale === 'hu' ? '/adatvedelem' : `/${locale}/adatvedelem`;
const thankYouLink = locale === 'hu' ? '/koszonjuk' : `/${locale}/koszonjuk`;

// Product options from constants with translations
const productOptions = CATEGORIES.map((cat) => ({
  value: cat.id,
  label: t(locale, `categories.${cat.id}`) || cat.nameShort,
}));

// Add "Other" option
productOptions.push({ value: 'egyeb', label: t(locale, 'common.other') || 'Other' });

const formId = `contact-form-${Math.random().toString(36).slice(2, 8)}`;
---

<form
  id={formId}
  class:list={['contact-form', className]}
  action="/api/contact"
  method="POST"
  novalidate
  data-contact-form
>
  <!-- Hidden fields for tracking -->
  <input type="hidden" name="sourceUrl" value={sourceUrl} />
  <input type="hidden" name="formStartTime" data-form-start />
  <input type="hidden" name="gdprTimestamp" data-gdpr-timestamp />
  <input type="hidden" name="utmSource" data-utm="utm_source" />
  <input type="hidden" name="utmMedium" data-utm="utm_medium" />
  <input type="hidden" name="utmCampaign" data-utm="utm_campaign" />

  <!-- Honeypot - hidden from users, bots will fill it -->
  <div class="absolute -left-[9999px] h-0 overflow-hidden" aria-hidden="true">
    <label for={`${formId}-website`}>{t(locale, 'form.honeypot')}</label>
    <input
      type="text"
      name="honeypot"
      id={`${formId}-website`}
      tabindex="-1"
      autocomplete="off"
    />
  </div>

  <div class:list={['grid gap-4', compact ? 'md:grid-cols-2' : 'gap-5']}>
    <!-- Name -->
    <div class={compact ? '' : 'md:col-span-1'}>
      <label for={`${formId}-name`} class="block text-sm font-medium text-gray-700 mb-2">
        {t(locale, 'form.name')} <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="name"
        id={`${formId}-name`}
        required
        autocomplete="name"
        placeholder={t(locale, 'form.namePlaceholder')}
        class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
      <p class="mt-1 text-sm text-red-600 hidden" data-error="name"></p>
    </div>

    <!-- Email -->
    <div class={compact ? '' : 'md:col-span-1'}>
      <label for={`${formId}-email`} class="block text-sm font-medium text-gray-700 mb-2">
        {t(locale, 'form.email')} <span class="text-red-500">*</span>
      </label>
      <input
        type="email"
        name="email"
        id={`${formId}-email`}
        required
        autocomplete="email"
        placeholder={t(locale, 'form.emailPlaceholder')}
        class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
      <p class="mt-1 text-sm text-red-600 hidden" data-error="email"></p>
    </div>

    <!-- Phone -->
    <div class={compact ? '' : 'md:col-span-1'}>
      <label for={`${formId}-phone`} class="block text-sm font-medium text-gray-700 mb-2">
        {t(locale, 'form.phone')} <span class="text-red-500">*</span>
      </label>
      <input
        type="tel"
        name="phone"
        id={`${formId}-phone`}
        required
        autocomplete="tel"
        placeholder={t(locale, 'form.phonePlaceholder')}
        class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
      <p class="mt-1 text-sm text-red-600 hidden" data-error="phone"></p>
    </div>

    <!-- Product selection -->
    <div class={compact ? '' : 'md:col-span-1'}>
      <label for={`${formId}-product`} class="block text-sm font-medium text-gray-700 mb-2">
        {t(locale, 'form.product')} <span class="text-red-500">*</span>
      </label>
      <div class="relative">
        <select
          name="product"
          id={`${formId}-product`}
          required
          class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 appearance-none cursor-pointer"
        >
          <option value="" disabled selected={!product}>{t(locale, 'form.productPlaceholder')}</option>
          {productOptions.map((opt) => (
            <option value={opt.value} selected={opt.value === product}>
              {opt.label}
            </option>
          ))}
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
          <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </div>
      </div>
      <p class="mt-1 text-sm text-red-600 hidden" data-error="product"></p>
    </div>

    <!-- Message (optional) -->
    <div class={compact ? 'md:col-span-2' : ''}>
      <label for={`${formId}-message`} class="block text-sm font-medium text-gray-700 mb-2">
        {t(locale, 'form.message')} <span class="text-gray-400 font-normal">({t(locale, 'common.optional') || 'optional'})</span>
      </label>
      <textarea
        name="message"
        id={`${formId}-message`}
        rows={compact ? 3 : 4}
        maxlength="2000"
        placeholder={t(locale, 'form.messagePlaceholder')}
        class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-y"
      ></textarea>
      <p class="mt-1 text-sm text-red-600 hidden" data-error="message"></p>
    </div>

    <!-- Turnstile CAPTCHA -->
    {turnstileSiteKey && (
      <div class={compact ? 'md:col-span-2' : ''}>
        <div
          class="cf-turnstile"
          data-sitekey={turnstileSiteKey}
          data-callback="onTurnstileSuccess"
          data-error-callback="onTurnstileError"
          data-theme="light"
        ></div>
        <p class="mt-1 text-sm text-red-600 hidden" data-error="cf-turnstile-response"></p>
      </div>
    )}

    <!-- GDPR Consent -->
    <div class={compact ? 'md:col-span-2' : ''}>
      <label class="flex items-start gap-3 cursor-pointer group">
        <input
          type="checkbox"
          name="gdprConsent"
          value="true"
          required
          class="mt-1 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 cursor-pointer"
          data-gdpr-checkbox
        />
        <span class="text-sm text-gray-600 group-hover:text-gray-900">
          {t(locale, 'form.gdprConsentPrefix')}{' '}
          <a href={privacyLink} target="_blank" class="text-primary-600 hover:underline">
            {t(locale, 'form.gdprConsentLink')}
          </a>.{' '}
          <span class="text-red-500">*</span>
        </span>
      </label>
      <p class="mt-1 text-sm text-red-600 hidden" data-error="gdprConsent"></p>
    </div>

    <!-- Submit button -->
    <div class={compact ? 'md:col-span-2' : ''}>
      <button
        type="submit"
        class="w-full inline-flex items-center justify-center px-6 py-3 font-semibold rounded-lg bg-primary-600 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        data-submit-button
        data-submit-text={t(locale, 'form.submit')}
        data-submitting-text={t(locale, 'form.submitting')}
      >
        <span data-button-text>{t(locale, 'form.submit')}</span>
        <svg class="hidden ml-2 h-5 w-5 animate-spin" data-loading-spinner viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Success message -->
  <div class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg" data-success-message data-thank-you-link={thankYouLink}>
    <div class="flex items-start gap-3">
      <svg class="h-6 w-6 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <h4 class="font-semibold text-green-800">{t(locale, 'form.success')}</h4>
        <p class="text-sm text-green-700">{t(locale, 'form.successMessage')}</p>
      </div>
    </div>
  </div>

  <!-- Error message -->
  <div
    class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg"
    data-error-message
    data-network-error={t(locale, 'form.networkError')}
    data-validation-error={t(locale, 'form.validationError')}
  >
    <div class="flex items-start gap-3">
      <svg class="h-6 w-6 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <h4 class="font-semibold text-red-800">{t(locale, 'form.error')}</h4>
        <p class="text-sm text-red-700" data-error-text>{t(locale, 'form.errorMessage')}</p>
      </div>
    </div>
  </div>
</form>

<!-- Turnstile script (loaded once) -->
<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  // Turnstile callbacks (global)
  declare global {
    interface Window {
      onTurnstileSuccess: (token: string) => void;
      onTurnstileError: () => void;
    }
  }

  let turnstileToken = '';

  window.onTurnstileSuccess = (token: string) => {
    turnstileToken = token;
  };

  window.onTurnstileError = () => {
    turnstileToken = '';
  };

  // Form handling
  document.querySelectorAll('[data-contact-form]').forEach((form) => {
    const formEl = form as HTMLFormElement;

    // Set form start time for time-check spam protection
    const startTimeInput = formEl.querySelector('[data-form-start]') as HTMLInputElement;
    if (startTimeInput) {
      startTimeInput.value = Date.now().toString();
    }

    // Capture UTM parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    formEl.querySelectorAll('[data-utm]').forEach((input) => {
      const utmParam = input.getAttribute('data-utm');
      if (utmParam) {
        (input as HTMLInputElement).value = urlParams.get(utmParam) || '';
      }
    });

    // GDPR timestamp on checkbox change
    const gdprCheckbox = formEl.querySelector('[data-gdpr-checkbox]') as HTMLInputElement;
    const gdprTimestamp = formEl.querySelector('[data-gdpr-timestamp]') as HTMLInputElement;

    gdprCheckbox?.addEventListener('change', () => {
      if (gdprCheckbox.checked && gdprTimestamp) {
        gdprTimestamp.value = new Date().toISOString();
      }
    });

    // Form submission
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitButton = formEl.querySelector('[data-submit-button]') as HTMLButtonElement;
      const buttonText = formEl.querySelector('[data-button-text]') as HTMLSpanElement;
      const spinner = formEl.querySelector('[data-loading-spinner]') as SVGElement;
      const successMessage = formEl.querySelector('[data-success-message]') as HTMLDivElement;
      const errorMessage = formEl.querySelector('[data-error-message]') as HTMLDivElement;
      const errorText = formEl.querySelector('[data-error-text]') as HTMLParagraphElement;

      // Reset previous errors
      formEl.querySelectorAll('[data-error]').forEach((el) => {
        el.classList.add('hidden');
        el.textContent = '';
      });
      formEl.querySelectorAll('input, select, textarea').forEach((el) => {
        el.classList.remove('border-red-300');
      });
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');

      // Show loading state
      submitButton.disabled = true;
      buttonText.textContent = submitButton.getAttribute('data-submitting-text') || 'Sending...';
      spinner?.classList.remove('hidden');

      try {
        const formData = new FormData(formEl);

        // Add turnstile token
        if (turnstileToken) {
          formData.set('cf-turnstile-response', turnstileToken);
        }

        const response = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          // Show success
          successMessage?.classList.remove('hidden');
          formEl.reset();

          // Reset start time for new submission
          if (startTimeInput) {
            startTimeInput.value = Date.now().toString();
          }

          // Track conversion (if GA4 available)
          if (typeof gtag === 'function') {
            gtag('event', 'generate_lead', {
              event_category: 'Contact',
              event_label: formData.get('product'),
              lead_id: result.leadId,
            });
          }

          // Redirect to thank-you page after short delay
          const thankYouLink = successMessage?.getAttribute('data-thank-you-link') || '/koszonjuk';
          setTimeout(() => {
            window.location.href = `${thankYouLink}?lead=${result.leadId}`;
          }, 1500);
        } else {
          // Show field errors
          if (result.errors) {
            Object.entries(result.errors).forEach(([field, messages]) => {
              const errorEl = formEl.querySelector(`[data-error="${field}"]`) as HTMLParagraphElement;
              const inputEl = formEl.querySelector(`[name="${field}"]`) as HTMLInputElement;

              if (errorEl && Array.isArray(messages) && messages.length > 0) {
                errorEl.textContent = messages[0];
                errorEl.classList.remove('hidden');
              }

              if (inputEl) {
                inputEl.classList.add('border-red-300');
              }
            });
          }

          // Show general error
          errorMessage?.classList.remove('hidden');
          if (errorText) {
            const validationError = errorMessage?.getAttribute('data-validation-error') || 'Please check the entered data.';
            errorText.textContent = result.error || validationError;
          }
        }
      } catch (error) {
        // Network error
        errorMessage?.classList.remove('hidden');
        if (errorText) {
          const networkError = errorMessage?.getAttribute('data-network-error') || 'A network error occurred. Please try again.';
          errorText.textContent = networkError;
        }
      } finally {
        // Reset button
        submitButton.disabled = false;
        buttonText.textContent = submitButton.getAttribute('data-submit-text') || 'Submit';
        spinner?.classList.add('hidden');
      }
    });
  });
</script>

---
/**
 * ProductGallery - Optimized product image gallery with thumbnails
 *
 * Accepts string paths and resolves them to ImageMetadata via glob import.
 * Uses ContentImage pattern for main image (50vw desktop, 100vw mobile)
 *
 * Features:
 * - Lightbox with zoom
 * - Thumbnail navigation
 * - Keyboard navigation (arrows, escape)
 * - Touch swipe support
 * - Optimized images via Astro Picture
 */
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';

// Import all product images for dynamic resolution
const productImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/products/**/*.{jpg,jpeg,png,webp,avif}',
  { eager: true }
);

interface Props {
  /** Array of image paths (strings) - will be resolved to ImageMetadata */
  images: string[];
  productName: string;
  badges?: {
    featured?: boolean;
    variantCount?: number;
  };
}

const { images, productName, badges } = Astro.props;

// Resolve image path to ImageMetadata
function resolveImage(imgPath: string): ImageMetadata | null {
  if (!imgPath) return null;

  // Normalize path variations
  let normalizedPath = imgPath;

  // Handle @assets/ prefix (from content files)
  if (normalizedPath.startsWith('@assets/')) {
    normalizedPath = `/src/assets/${normalizedPath.slice(8)}`;
  }
  // Handle assets/ prefix (without @)
  else if (normalizedPath.startsWith('assets/')) {
    normalizedPath = `/src/${normalizedPath}`;
  }
  // Handle /assets/ prefix
  else if (normalizedPath.startsWith('/assets/')) {
    normalizedPath = `/src${normalizedPath}`;
  }
  // Handle paths without prefix - assume products folder
  else if (!normalizedPath.startsWith('/src/')) {
    const filename = normalizedPath.split('/').pop();
    normalizedPath = `/src/assets/products/${filename}`;
  }

  // Look up in glob imports
  const resolved = productImages[normalizedPath];
  return resolved?.default || null;
}

// Filter and resolve valid images
const resolvedImages = images
  .filter(Boolean)
  .map(resolveImage)
  .filter((img): img is ImageMetadata => img !== null);

// Main image pattern: ContentImage (50vw desktop, 100vw mobile)
const mainWidths = [320, 480, 640, 960, 1280, 1600];
const mainSizes = '(min-width: 1024px) 50vw, 100vw';

// Thumbnail pattern: small fixed sizes
const thumbWidths = [160, 320, 480];
const thumbSizes = '80px';

// Lightbox pattern: HeroImage (100vw)
const lightboxWidths = [320, 480, 640, 828, 1080, 1200, 1920, 2560];
const lightboxSizes = '100vw';
---

<div class="product-gallery" data-gallery>
  <!-- Main Image Container -->
  <div class="relative aspect-square bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl overflow-hidden mb-4">
    {resolvedImages.length > 0 ? (
      <button
        type="button"
        class="w-full h-full cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-inset"
        data-open-lightbox
        aria-label="Kép nagyítása"
      >
        <Picture
          src={resolvedImages[0]}
          alt={productName}
          widths={mainWidths}
          sizes={mainSizes}
          formats={['avif', 'webp', 'jpeg']}
          quality={75}
          class="w-full h-full object-contain p-4 gallery-main-image"
          loading="eager"
          fetchpriority="high"
          data-main-image
          data-index="0"
        />
      </button>
    ) : (
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="text-center p-8">
          <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white shadow-lg flex items-center justify-center">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <p class="text-gray-500 font-medium">Kép hamarosan</p>
        </div>
      </div>
    )}

    <!-- Badges -->
    {(badges?.featured || badges?.variantCount) && (
      <div class="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none">
        {badges.featured && (
          <span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
            BESTSELLER
          </span>
        )}
        {badges.variantCount && badges.variantCount > 1 && (
          <span class="bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
            {badges.variantCount} variáció
          </span>
        )}
      </div>
    )}

    <!-- Zoom indicator -->
    {resolvedImages.length > 0 && (
      <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur-sm rounded-full p-2 shadow-lg pointer-events-none">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
        </svg>
      </div>
    )}
  </div>

  <!-- Thumbnails -->
  {resolvedImages.length > 1 && (
    <div class="grid grid-cols-5 sm:grid-cols-6 gap-2" role="tablist" aria-label="Termékképek">
      {resolvedImages.slice(0, 6).map((img, i) => (
        <button
          type="button"
          role="tab"
          aria-selected={i === 0 ? 'true' : 'false'}
          aria-label={`${productName} - kép ${i + 1}`}
          class:list={[
            'aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer transition-all',
            'hover:ring-2 hover:ring-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500',
            i === 0 ? 'ring-2 ring-primary-600' : ''
          ]}
          data-thumbnail={i}
        >
          <Picture
            src={img}
            alt={`${productName} - kép ${i + 1}`}
            widths={thumbWidths}
            sizes={thumbSizes}
            formats={['avif', 'webp', 'jpeg']}
            quality={60}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </button>
      ))}
    </div>
  )}

  <!-- Image counter for mobile -->
  {resolvedImages.length > 1 && (
    <div class="mt-3 text-center text-sm text-gray-500 sm:hidden">
      <span data-current-index>1</span> / {resolvedImages.length} kép
    </div>
  )}

  <!-- Lightbox -->
  <div
    class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm"
    data-lightbox
    role="dialog"
    aria-modal="true"
    aria-label="Képnagyító"
  >
    <!-- Close button -->
    <button
      type="button"
      class="absolute top-4 right-4 z-10 p-2 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full transition-colors"
      data-close-lightbox
      aria-label="Bezárás"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Navigation arrows -->
    {resolvedImages.length > 1 && (
      <>
        <button
          type="button"
          class="absolute left-4 top-1/2 -translate-y-1/2 z-10 p-3 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full transition-colors"
          data-prev
          aria-label="Előző kép"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button
          type="button"
          class="absolute right-4 top-1/2 -translate-y-1/2 z-10 p-3 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full transition-colors"
          data-next
          aria-label="Következő kép"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </>
    )}

    <!-- Lightbox image container -->
    <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
      {resolvedImages.map((img, i) => (
        <div
          class:list={[
            'lightbox-slide absolute inset-0 flex items-center justify-center p-4 sm:p-8 transition-opacity duration-300',
            i === 0 ? 'opacity-100' : 'opacity-0 pointer-events-none'
          ]}
          data-slide={i}
        >
          <Picture
            src={img}
            alt={`${productName} - kép ${i + 1}`}
            widths={lightboxWidths}
            sizes={lightboxSizes}
            formats={['avif', 'webp', 'jpeg']}
            quality={85}
            class="max-w-full max-h-full object-contain"
            loading="lazy"
          />
        </div>
      ))}
    </div>

    <!-- Counter -->
    {resolvedImages.length > 1 && (
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 text-sm bg-white/10 px-3 py-1 rounded-full">
        <span data-lightbox-index>1</span> / {resolvedImages.length}
      </div>
    )}

    <!-- Thumbnail strip -->
    {resolvedImages.length > 1 && (
      <div class="absolute bottom-16 left-1/2 -translate-x-1/2 flex gap-2 max-w-full overflow-x-auto px-4 pb-2">
        {resolvedImages.map((img, i) => (
          <button
            type="button"
            class:list={[
              'w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden transition-all',
              'hover:ring-2 hover:ring-white/50',
              i === 0 ? 'ring-2 ring-white' : 'opacity-60 hover:opacity-100'
            ]}
            data-lightbox-thumb={i}
            aria-label={`Kép ${i + 1}`}
          >
            <Picture
              src={img}
              alt=""
              widths={[160, 320]}
              sizes="64px"
              formats={['avif', 'webp', 'jpeg']}
              quality={50}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </button>
        ))}
      </div>
    )}
  </div>
</div>

<script>
  // Initialize all galleries on the page
  document.querySelectorAll('[data-gallery]').forEach((gallery) => {
    const mainImageContainer = gallery.querySelector('[data-open-lightbox]');
    let mainPicture = mainImageContainer?.querySelector('picture');
    const thumbnails = gallery.querySelectorAll('[data-thumbnail]');
    const lightbox = gallery.querySelector('[data-lightbox]');
    const slides = gallery.querySelectorAll('[data-slide]');
    const lightboxThumbs = gallery.querySelectorAll('[data-lightbox-thumb]');
    const openBtn = gallery.querySelector('[data-open-lightbox]');
    const closeBtn = gallery.querySelector('[data-close-lightbox]');
    const prevBtn = gallery.querySelector('[data-prev]');
    const nextBtn = gallery.querySelector('[data-next]');
    const currentIndexEl = gallery.querySelector('[data-current-index]');
    const lightboxIndexEl = gallery.querySelector('[data-lightbox-index]');

    let currentIndex = 0;
    const totalImages = slides.length || 1;

    // Store all thumbnail pictures for swapping
    const thumbPictures: HTMLElement[] = [];
    thumbnails.forEach((thumb) => {
      const picture = thumb.querySelector('picture');
      if (picture) thumbPictures.push(picture.cloneNode(true) as HTMLElement);
    });

    // Update main gallery image by swapping picture element content
    function updateMainImage(index: number) {
      currentIndex = index;

      // Update thumbnail states
      thumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('ring-2', i === index);
        thumb.classList.toggle('ring-primary-600', i === index);
        thumb.setAttribute('aria-selected', i === index ? 'true' : 'false');
      });

      // Swap main picture with thumbnail picture
      if (mainPicture && thumbPictures[index]) {
        const newPicture = thumbPictures[index].cloneNode(true) as HTMLElement;
        const newImg = newPicture.querySelector('img');
        if (newImg) {
          // Apply main image styles
          newImg.className = 'w-full h-full object-contain p-4 gallery-main-image';
          newImg.setAttribute('loading', 'eager');
          newImg.setAttribute('fetchpriority', 'high');
          newImg.setAttribute('data-main-image', '');
          newImg.setAttribute('data-index', String(index));
        }
        if (mainPicture) {
          mainPicture.replaceWith(newPicture);
          // Update reference to the new picture
          mainPicture = mainImageContainer?.querySelector('picture');
        }
      }

      // Update counter
      if (currentIndexEl) {
        currentIndexEl.textContent = String(index + 1);
      }
    }

    // Update lightbox
    function updateLightbox(index: number) {
      currentIndex = index;

      slides.forEach((slide, i) => {
        slide.classList.toggle('opacity-100', i === index);
        slide.classList.toggle('opacity-0', i !== index);
        slide.classList.toggle('pointer-events-none', i !== index);
      });

      lightboxThumbs.forEach((thumb, i) => {
        thumb.classList.toggle('ring-2', i === index);
        thumb.classList.toggle('ring-white', i === index);
        thumb.classList.toggle('opacity-60', i !== index);
      });

      if (lightboxIndexEl) {
        lightboxIndexEl.textContent = String(index + 1);
      }
    }

    // Open lightbox
    function openLightbox() {
      if (!lightbox) return;
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      updateLightbox(currentIndex);
    }

    // Close lightbox
    function closeLightbox() {
      if (!lightbox) return;
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Navigate
    function goNext() {
      updateLightbox((currentIndex + 1) % totalImages);
    }

    function goPrev() {
      updateLightbox((currentIndex - 1 + totalImages) % totalImages);
    }

    // Event listeners - thumbnails open lightbox at that index
    thumbnails.forEach((thumb, i) => {
      thumb.addEventListener('click', () => {
        updateMainImage(i);
        updateLightbox(i);
        openLightbox();
      });
    });

    openBtn?.addEventListener('click', openLightbox);
    closeBtn?.addEventListener('click', closeLightbox);
    prevBtn?.addEventListener('click', goPrev);
    nextBtn?.addEventListener('click', goNext);

    lightboxThumbs.forEach((thumb, i) => {
      thumb.addEventListener('click', () => updateLightbox(i));
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox || lightbox.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') goPrev();
      if (e.key === 'ArrowRight') goNext();
    });

    // Click outside to close
    lightbox?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      // Close if clicking the backdrop or slide container (not the image itself)
      if (target === lightbox || target.hasAttribute('data-slide')) {
        closeLightbox();
      }
    });

    // Touch swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    lightbox?.addEventListener('touchstart', (e) => {
      touchStartX = (e as TouchEvent).changedTouches[0].screenX;
    }, { passive: true });

    lightbox?.addEventListener('touchend', (e) => {
      touchEndX = (e as TouchEvent).changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) goNext();
        else goPrev();
      }
    }, { passive: true });
  });
</script>

<style>
  .gallery-main-image {
    transition: transform 0.3s ease;
  }

  [data-open-lightbox]:hover .gallery-main-image {
    transform: scale(1.02);
  }

  /* Smooth transitions in lightbox */
  .lightbox-slide {
    will-change: opacity;
  }

  /* Focus for keyboard nav */
  [data-lightbox]:focus {
    outline: none;
  }
</style>
